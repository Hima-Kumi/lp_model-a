<!doctype html>
<html lang="ja">
<head>
  <!-- Revision: 改訂No.002（運用分離版 / Public API連携） -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coffee & Restaurant – マイルド</title>
  <meta name="description" content="いつもの一日を、ちょっと上質に。阿南市の喫茶・レストラン。駐車14台、朝7:00〜営業。">

  <style>
    :root{
      --bg:#0b0c0e; --surface:#ffffff; --muted:#f6f7f9; --border:#e8eaef;
      --brand:#16a34a; --text:#14161a; --text-dim:#5b6472;
      --radius:16px; --shadow:0 6px 20px rgba(9,12,18,.08); --shadow-hover:0 10px 28px rgba(9,12,18,.12);
      --speed:140ms; --container:1100px;
      --badge-bg: color-mix(in srgb, var(--brand) 10%, #eef2f7);
      --badge-fg: color-mix(in srgb, var(--brand) 70%, #26323f);
      --header-h: 60px;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{ margin:0; color:var(--text); background:#fff;
      font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",Arial,sans-serif; letter-spacing:.01em;}
    img{ max-width:100%; height:auto; display:block; }
    a{ color:inherit; text-decoration:none; }
    .container{ width:min(100% - 24px, var(--container)); margin-inline:auto; }
    h1,h2,h3{ line-height:1.25; letter-spacing:.004em; margin:0 0 .5em; }
    h1{ font-weight:800; font-size:clamp(28px,4.5vw,44px); }
    h2{ font-weight:700; font-size:clamp(20px,3.2vw,28px); }
    p{ margin:.6em 0; }
    small,.muted{ color:var(--text-dim); }

    /* ===== Header ===== */
    header.site-header{ position:sticky; top:0; z-index:50; background:#fff;
      border-bottom:1px solid var(--border); backdrop-filter:blur(10px); }
    .nav{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding:10px 0; }
    .brand{ display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .brand__logo{ width:36px; height:36px; border-radius:10px; background:var(--brand); box-shadow:var(--shadow); flex:0 0 auto; }
    .brand__name{ display:flex; flex-direction:column; line-height:1.1; }
    .brand__name .line1{ font-size:.92rem; color:var(--text-dim); }
    .brand__name .line2{ font-size:1.08rem; font-weight:800; color:var(--text); }
    .nav-right{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .nav-link{ padding:8px 10px; border-radius:10px; }
    .nav-link:hover{ background:var(--muted); }
    .nav-right .btn-primary{ padding:.55rem .85rem; border-radius:999px; font-weight:700; font-size:.95rem; }
    @media (max-width:900px){
      .nav-right{ gap:4px; }
      .nav-link{ padding:6px 8px; font-size:.95rem; }
      .nav-right .btn-primary{ padding:.5rem .8rem; font-size:.95rem; }
    }

    /* ===== Hero ===== */
    .hero{ background:linear-gradient(180deg, var(--bg), #14161a); color:#fff; padding:clamp(28px,6vw,80px) 0; }
    .hero .wrap{ display:grid; gap:20px; align-items:center; grid-template-columns:1.2fr .8fr; }
    @media (max-width:900px){ .hero .wrap{ grid-template-columns:1fr; } }
    .chip{ display:inline-flex; gap:.5em; align-items:center; font-size:.9rem; padding:.4rem .7rem; border-radius:999px; border:1px solid rgba(255,255,255,.16); color:#e5e7eb; background:rgba(255,255,255,.06); }
    /* ★ Hero画像のアスペクト比を“元通り”に固定（4:3） */
    .hero .media-rounded{ aspect-ratio: 4 / 3; max-width: 720px; margin-left:auto; }
    .hero .media-rounded img{ width:100%; height:100%; object-fit:cover; border-radius:clamp(12px,2vw,20px); }

    /* ===== Sections & Cards ===== */
    .section{ padding:clamp(28px,5vw,64px) 0; }
    .section.is-muted{ background:var(--muted); border-block:1px solid var(--border); }
    .section-title{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .hint-inline{
      display:inline-flex; align-items:center; gap:.35em; font-size:.9rem; font-weight:700;
      padding:.22rem .55rem; border-radius:999px;
      background: var(--badge-bg); color: var(--badge-fg); border:1px solid color-mix(in srgb, var(--brand) 18%, var(--border));
    }
    .grid-3{ display:grid; gap:16px; grid-template-columns:repeat(3,1fr); }
    @media (max-width:900px){ .grid-3{ grid-template-columns:1fr; } }

    .card{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      transition:transform var(--speed) ease, box-shadow var(--speed) ease; overflow:hidden;}
    .card:hover{ transform:translateY(-2px); box-shadow:var(--shadow-hover); }
    .card .pad{ padding:16px; }
    .card img{ border-bottom:1px solid var(--border); object-fit:cover; aspect-ratio:4/3; }
    .badge{ display:inline-flex; align-items:center; gap:.35em; padding:.28rem .6rem; border-radius:999px; font-size:.85rem;
      background:linear-gradient(180deg,#fff,#f1f5f9); border:1px solid var(--border); color:#2e3a49; }

    /* ===== Buttons & Inputs ===== */
    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn{ display:inline-flex; align-items:center; gap:.6em; font-weight:700; padding:.9rem 1.2rem; border-radius:999px; box-shadow:var(--shadow);
      transition:transform var(--speed) ease, box-shadow var(--speed) ease, background var(--speed) ease; border:1px solid transparent; }
    .btn-primary{ background:var(--brand); color:#fff; }
    .btn-ghost{ background:#fff; color:#14161a; border:1px solid var(--border); }

    input[type],textarea,select,.input{
      width:100%; border:1px solid var(--border); border-radius:12px;
      padding:.85rem 1rem; background:#fff; outline:none; min-width:0;
      transition: box-shadow var(--speed) ease, border var(--speed) ease;
    }
    input:focus,textarea:focus,select:focus{
      border-color: color-mix(in srgb, var(--brand) 50%, var(--border));
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--brand) 18%, transparent);
    }
    .input.email{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:1.05rem; letter-spacing:.02em; padding:1rem 1.1rem; }

    /* ===== Horizontal Snap ===== */
    .snap-row{ display:flex; gap:16px; overflow:auto; scroll-snap-type:x mandatory; padding-bottom:8px; }
    .snap-row > *{ flex:0 0 auto; width:280px; scroll-snap-align:start; }

    /* ===== Footer banner ===== */
    footer.sticky-banner{ position: sticky; bottom:0; z-index:40; padding:12px 0;
      background: color-mix(in srgb, #fff 90%, transparent); border-top:1px solid var(--border); backdrop-filter: blur(8px); }
    .banner-text{ display:flex; align-items:center; justify-content:center; text-align:center; gap:.6rem; font-weight:700; }

    /* ===== Mobile compact for Reserve & Reviews ===== */
    @media (max-width:900px){
      #reserveForm.card{ padding:12px !important; }
      .form-grid{ gap:12px !important; }
      .form-grid-3{ gap:12px !important; }
      #reserveForm .input{ padding:.7rem .9rem; }
      #reserveForm textarea{ min-height: 88px; }
      #reserveForm .actions .btn,
      #reserveForm .actions .btn-ghost{ padding:.65rem .95rem; }

      /* 口コミコンパクト：カードpadding縮小＋3行クランプ */
      #reviewsList .card .pad{ padding:12px; }
      .clamp-3{
        display:-webkit-box;
        -webkit-line-clamp:3;
        line-clamp:3; /* ★ 警告対策：標準プロパティも併記 */
        -webkit-box-orient:vertical;
        overflow:hidden;
      }
    }

    /* ===== Anchor offset（見出しがヘッダーに隠れない） ===== */
    .section, [id]{ scroll-margin-top: calc(var(--header-h) + 10px); }

    /* ★ レビュー星を金色に */
    .stars{ color:#d4af37; } /* ゴールド */

    /* ================================
       ★ 追記：Liquid Glass（header/footerのみ・最小差分）
       ================================ */
    :root{
      --glass-bg: color-mix(in srgb, #ffffff 14%, transparent);
      --glass-stroke: color-mix(in srgb, #ffffff 38%, transparent);
      --glass-blur: 16px;
      --glass-saturate: 160%;
      --glass-shadow: 0 10px 30px rgba(10,12,16,.18);
    }
    .theme-liquid header.site-header,
    .theme-liquid footer.sticky-banner{
      background: var(--glass-bg);
      border-color: var(--glass-stroke);
      backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
      -webkit-backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
      box-shadow: var(--glass-shadow);
    }
    @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
      .theme-liquid header.site-header,
      .theme-liquid footer.sticky-banner{ background: inherit; }
    }

    .theme-liquid .card{
      background: var(--glass-bg);
      border-color: var(--glass-stroke);
      backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
      -webkit-backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
      box-shadow: var(--glass-shadow);
    }
    .theme-liquid .card > img,
    .theme-liquid .card .media > img{
      outline: 1px solid color-mix(in srgb, #ffffff 20%, transparent);
      outline-offset: -1px;
    }
    .theme-liquid .glassable{
      background: var(--glass-bg);
      border: 1px solid var(--glass-stroke);
      backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
      -webkit-backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
      box-shadow: var(--glass-shadow);
    }
    @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))) {
      .theme-liquid .card,
      .theme-liquid .glassable{
        background:#fff;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="site-header" id="siteHeader">
    <div class="container nav">
      <div class="brand" id="brandName">
        <div class="brand__logo" aria-hidden="true"></div>
        <div class="brand__name">
          <span class="line1" data-bind="brandLine1">Coffee & Restaurant</span>
          <span class="line2" data-bind="brandLine2">マイルド</span>
        </div>
      </div>
      <div class="nav-right" id="siteNav">
        <a class="nav-link" href="#menu">メニュー</a>
        <a class="nav-link" href="#news">お知らせ</a>
        <a class="nav-link" href="#reviews">口コミ</a>
        <a class="nav-link" href="#info">店舗情報</a>
        <a class="btn btn-primary" href="#reserve">空席確認・予約</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="hero" id="hero">
    <div class="container wrap">
      <div>
        <span class="chip" id="hoursChip" data-bind="hours">本日 7:00–18:00（L.O. 17:30）/ 火曜定休</span>
        <h1 id="heroTitle" data-bind="heroTitle">いつもの一日を、ちょっと上質に。</h1>
        <p id="heroLead" data-bind="heroLead">焼きたてトーストと淹れたての香り。阿南市の憩いの一軒です。</p>
      </div>
      <div class="media-rounded">
        <img id="heroImage" data-bind="heroImage" src="https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?q=80&w=1600&auto=format&fit=crop" alt="店内の雰囲気">
      </div>
    </div>
  </section>

  <!-- Reasons -->
  <section class="section is-muted" id="reasons">
    <div class="container">
      <h2 class="section-title">選ばれる理由</h2>
      <div class="grid-3" id="reasonsList"></div>
    </div>
  </section>

  <!-- Menu -->
  <section class="section" id="menu">
    <div class="container">
      <div class="section-title">
        <h2>看板メニュー</h2>
        <span class="hint-inline" aria-hidden="true">⟶ スワイプ</span>
      </div>
      <div class="snap-row" id="menuList"></div>
    </div>
  </section>

  <!-- News -->
  <section class="section is-muted" id="news">
    <div class="container">
      <div class="section-title">
        <h2>お知らせ</h2>
        <a id="newsToggle" class="hint-inline" href="#news" aria-expanded="false">過去のお知らせも見る</a>
      </div>
      <div class="grid-3" id="newsList"></div>
      <div class="grid-3" id="newsListMore" style="display:none; margin-top:8px;"></div>
    </div>
  </section>

  <!-- Reviews -->
  <section class="section" id="reviews">
    <div class="container">
      <div class="section-title">
        <h2>口コミ</h2>
        <a id="reviewsToggle" class="hint-inline" href="#reviews" aria-expanded="false">過去の口コミも見る</a>
      </div>
      <div class="grid-3" id="reviewsList"></div>
      <div class="grid-3" id="reviewsListMore" style="display:none; margin-top:8px;"></div>
    </div>
  </section>

  <!-- Info -->
  <section class="section is-muted" id="info">
    <div class="container">
      <h2 class="section-title">店舗情報</h2>
      <div class="grid-3">
        <div class="card"><div class="pad">
          <strong>住所</strong>
          <p id="addr" data-bind="address">徳島県阿南市◯◯1-2-3</p>
          <a class="btn btn-ghost" id="mapLink" data-bind="mapLinkHref|mapLinkText" href="#access">地図を見る</a>
        </div></div>
        <div class="card"><div class="pad">
          <strong>営業時間</strong>
          <p id="hours" data-bind="hours">7:00–18:00（L.O. 17:30）/ 火曜定休</p>
        </div></div>
        <div class="card"><div class="pad">
          <strong>駐車場</strong>
          <p id="parking" data-bind="parking">駐車14台／広い出入口で出入りラクラク</p>
        </div></div>
      </div>
    </div>
  </section>

  <!-- Access -->
  <section class="section" id="access">
    <div class="container">
      <h2 class="section-title">アクセス</h2>
      <div class="card">
        <iframe id="mapFrame" data-bind="mapSrc"
          src="https://www.openstreetmap.org/export/embed.html?bbox=139.70%2C35.68%2C139.72%2C35.69&layer=mapnik"
          style="width:100%; height:380px; border:0;"></iframe>
      </div>
    </div>
  </section>

  <!-- Reserve -->
  <section class="section is-muted" id="reserve">
    <div class="container">
      <h2 class="section-title">ご予約・お問い合わせ</h2>
      <form id="reserveForm" class="card" style="padding:16px;">
        <div class="form-grid">
          <div><label>お名前<input class="input" name="name" required></label></div>
          <div class="col-2"><label>メール<input class="input email" name="email" type="email" required inputmode="email" autocomplete="email" placeholder="example@example.com"></label></div>
        </div>
        <div class="form-grid-3">
          <div><label>電話番号<input class="input" name="tel" inputmode="tel" autocomplete="tel"></label></div>
          <div><label>ご来店日時<input class="input" name="datetime" type="datetime-local"></label></div>
          <div><label>人数<select class="input" name="people"><option>1</option><option>2</option><option>3</option><option>4</option><option>5+</option></select></label></div>
        </div>
        <div><label>ご要望<textarea class="input" name="msg" rows="3" placeholder="アレルギーや席のご希望など"></textarea></label></div>
        <div class="actions" style="margin-top:8px;">
          <button type="submit" class="btn btn-primary">送信する</button>
          <a class="btn btn-ghost" id="altFormLink" data-bind="altFormHref|altFormText" href="#">Googleフォームで送る</a>
        </div>
      </form>
    </div>
  </section>

  <!-- Footer banner -->
  <footer class="sticky-banner">
    <!-- 改訂No.003 追補：フッターバナーにポイントUI起動ボタン -->
    <div class="banner-text" style="gap:.8rem; flex-wrap:wrap;">
      <span id="footerBannerText" data-bind="footerBannerText">HP開設キャンペーン企画実施中</span>
      <a id="openLoyalty" class="btn-ghost" style="padding:.4rem .8rem; border-radius:999px; border:1px solid #e8eaef; cursor:pointer;">ポイント / クーポン</a>
    </div>
  </footer>

  <script>
    /* ==========================================================
       Public API（JSONP）
       A案：GAS → キャッシュ → DEFAULT の3段フォールバック
       ========================================================== */
    const PUBLIC_API_URL = "https://script.google.com/macros/s/AKfycby5FA9NjNhBY8W3m4xtxB4nNR23K71iE18mUId_xHf-vJho3Nf1z7QgpABEdbdU0IezGQ/exec";
    const SITE_KEY = "model-a";
    const STORAGE_KEY = "cafeSiteData_v21";          // 既存localStorage（あなたの元コード踏襲）
    const LS_CACHE_KEY = "site_current_cache_v1";    // ★ Public API成功キャッシュ（保険）

    /* ------------ Data ------------ */
    const DEFAULT_DATA = {
      brandColor:"#16a34a",
      brandLine1:"Coffee & Restaurant",
      brandLine2:"マイルド",
      heroTitle:"いつもの一日を、ちょっと上質に。",
      heroLead:"焼きたてトーストと淹れたての香り。阿南市の憩いの一軒です。",
      heroImage:"https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?q=80&w=1600&auto=format&fit=crop",
      hours:"7:00–18:00（L.O. 17:30）/ 火曜定休",
      address:"徳島県阿南市◯◯1-2-3",
      parking:"駐車14台／広い出入口で出入りラクラク",
      mapSrc:"https://www.openstreetmap.org/export/embed.html?bbox=139.70%2C35.68%2C139.72%2C35.69&layer=mapnik",
      mapLinkText:"地図を見る", mapLinkHref:"#access",
      altFormText:"Googleフォームで送る", altFormHref:"#",
      footerBannerText:"HP開設キャンペーン企画実施中",
      sectionsMuted:{ reasons:true, menu:false, news:true, reviews:false, info:true, reserve:true },
      reasons:[
        { title:"多彩なメニュー", text:"モーニングからランチ、スイーツまで幅広くご用意。", image:"https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=1600&auto=format&fit=crop" },
        { title:"くつろぎの空間", text:"木の温もりを感じる落ち着いた店内。", image:"https://images.unsplash.com/photo-1498654896293-37aacf113fd9?q=80&w=1600&auto=format&fit=crop" },
        { title:"駐車14台", text:"出入りしやすい広い駐車場を完備。", image:"https://images.unsplash.com/photo-1515266591878-f93e32bc5937?q=80&w=1600&auto=format&fit=crop" }
      ],

      menu:[
        {
          title:"厚切りバタートースト",
          desc:"外カリッと中ふわり。朝の定番。",
          price:"¥420",
          badge:"定番",
          image:"https://images.unsplash.com/photo-1533089860892-a7c6f0a88666?q=80&w=1600&auto=format&fit=crop"
        }
      ],
      
      news:[
        { title:"季節のデザート始まりました", text:"かぼちゃプリン・モンブランをご用意しています。", date:"2025-10-01" }
      ],
      reviews:[
        { name:"A.K.", text:"スタッフが親切で居心地が良い。ナポリタンが絶品でした！", rating:5, date:"2025-10-05" }
      ]
    };

    /* ------------ Utils ------------ */
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const $H = (id)=>document.getElementById(id);

    function safeJsonParse(str){
      try{ return JSON.parse(str); }catch(e){ return null; }
    }

    function saveLocal(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(window.__SITE_DATA__)); }catch(e){}
    }

    function saveCache(data){
      try{ localStorage.setItem(LS_CACHE_KEY, JSON.stringify(data)); }catch(e){}
    }

    function loadCache(){
      const cached = localStorage.getItem(LS_CACHE_KEY);
      return cached ? safeJsonParse(cached) : null;
    }

    /* ------------ Render ------------ */
    function applyData(d){
      document.documentElement.style.setProperty('--brand', d.brandColor || DEFAULT_DATA.brandColor);
      const bindMap = {
        brandLine1:'.brand__name .line1', brandLine2:'.brand__name .line2',
        heroTitle:'#heroTitle', heroLead:'#heroLead', heroImage:'#heroImage',
        hours:['#hours','#hoursChip'], address:'#addr', parking:'#parking',
        mapSrc:'#mapFrame', mapLinkText:'#mapLink', mapLinkHref:'#mapLink',
        altFormText:'#altFormLink', altFormHref:'#altFormLink',
        footerBannerText:'#footerBannerText',
      };
      for(const k in bindMap){
        const sel = bindMap[k];
        const targets = Array.isArray(sel)? sel.flatMap(s=> $$(s)) : $$(sel);
        targets.forEach(el=>{
          if(!el) return;
          if(k.toLowerCase().includes('href')) el.setAttribute('href', d[k] || '#');
          else if(k==='mapSrc' && el.tagName==='IFRAME') el.src = d[k];
          else if(k.toLowerCase().includes('image') || el.tagName==='IMG') el.setAttribute('src', d[k]);
          else el.textContent = d[k];
        });
      }

      // reasons
      const reasonsWrap = $('#reasonsList'); reasonsWrap.innerHTML='';
      (d.reasons||[]).forEach(item=>{
        const card=document.createElement('article'); card.className='card';
        card.innerHTML=`<img src="${item.image||''}" alt=""><div class="pad"><h3>${item.title||''}</h3><p class="muted">${item.text||''}</p></div>`;
        reasonsWrap.appendChild(card);
      });

      // menu
      const menuWrap = $('#menuList'); menuWrap.innerHTML='';
      (d.menu||[]).forEach(item=>{
        const badge=item.badge?`<span class="badge">${item.badge}</span>`:'';
        const card=document.createElement('article'); card.className='card'; card.style.width='280px';
        card.innerHTML=`<img src="${item.image||''}" alt=""><div class="pad">
            <div class="actions" style="justify-content:space-between;"><h3 style="margin:0;">${item.title||''}</h3>${badge}</div>
            <p class="muted">${item.desc||''}</p><strong>${item.price||''}</strong></div>`;
        menuWrap.appendChild(card);
      });

      // news：日付降順にソート → 上3件＋残り（最大5件）
      const sortedNews = (d.news||[]).slice().sort((a,b)=> new Date(b.date||0) - new Date(a.date||0)).slice(0,5);
      const first3 = sortedNews.slice(0,3);
      const rest = sortedNews.slice(3);
      const newsWrap = $('#newsList'); newsWrap.innerHTML='';
      first3.forEach(n=> newsWrap.appendChild(newsCard(n)));
      const moreWrap = $('#newsListMore'); moreWrap.innerHTML='';
      rest.forEach(n=> moreWrap.appendChild(newsCard(n)));

      // reviews：date補完→降順→最大30保持、表示は5件＋残り
      ensureReviewDates(d);
      const sortedReviews = (d.reviews||[]).slice().sort((a,b)=> new Date(b.date||0) - new Date(a.date||0)).slice(0,30);
      const rvFirst5 = sortedReviews.slice(0,5);
      const rvRest = sortedReviews.slice(5);
      const revWrap = $('#reviewsList'); revWrap.innerHTML='';
      rvFirst5.forEach(rv=> revWrap.appendChild(reviewCard(rv)));
      const revMore = $('#reviewsListMore'); revMore.innerHTML='';
      rvRest.forEach(rv=> revMore.appendChild(reviewCard(rv)));

      // sectionsMuted（既存DOMを変えずにクラス切替）
      applySectionMuted(d.sectionsMuted || DEFAULT_DATA.sectionsMuted);
    }

    function applySectionMuted(m){
      const map = {
        reasons: '#reasons',
        menu: '#menu',
        news: '#news',
        reviews: '#reviews',
        info: '#info',
        reserve: '#reserve'
      };
      Object.keys(map).forEach(k=>{
        const el = document.querySelector(map[k]);
        if(!el) return;
        el.classList.toggle('is-muted', !!m[k]);
      });
    }

    function newsCard(n){
      const card=document.createElement('article'); card.className='card';
      card.innerHTML=`<div class="pad"><small class="muted">${n.date||''}</small><h3>${n.title||''}</h3><p>${n.text||''}</p></div>`;
      return card;
    }
    function reviewCard(rv){
      const stars='★★★★★'.slice(0, Math.max(0, Math.min(5, rv.rating||0)));
      const card=document.createElement('article'); card.className='card';
      card.innerHTML=`<div class="pad"><strong class="stars" aria-label="評価">${stars}</strong><p class="clamp-3">${rv.text||''}</p><small class="muted">— ${rv.name||'匿名'} ・ ${rv.date||''}</small></div>`;
      return card;
    }
    function ensureReviewDates(d){
      let changed=false;
      (d.reviews||[]).forEach((r,i)=>{
        if(!r.date){
          const dt = new Date(); dt.setDate(dt.getDate() - i);
          r.date = dt.toISOString().slice(0,10);
          changed=true;
        }
      });
      if(changed){
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }catch(e){}
      }
    }

    /* ------------ JSONP load（Public API） ------------ */
    function loadFromPublicApiJSONP(){
      return new Promise((resolve)=>{
        if(!PUBLIC_API_URL){ resolve({ok:false, reason:'no_url'}); return; }

        const cb = "cb_site_" + Math.random().toString(36).slice(2);
        window[cb] = (res)=>{
          try{
            // GAS側が res.json でも res.data でも壊れないように吸収
            const payloadText = res && (res.json ?? res.data);
            if(res && res.ok && payloadText){
              const remoteObj = safeJsonParse(payloadText);
              if(remoteObj){
                saveCache(remoteObj);
                resolve({ok:true, data:remoteObj, raw:res});
                return;
              }
            }
          }catch(e){}
          resolve({ok:false, raw:res});
        };

        const s = document.createElement("script");
        s.src = `${PUBLIC_API_URL}?path=site&key=${encodeURIComponent(SITE_KEY)}&callback=${encodeURIComponent(cb)}&v=${Date.now()}`;
        s.onerror = ()=>{
          resolve({ok:false, reason:'script_error'});
        };
        s.onload = ()=>{
          // callbackが呼ばれないケースもあるので保険（極稀）
          setTimeout(()=> resolve({ok:false, reason:'timeout'}), 1200);
        };
        document.head.appendChild(s);

        // 終了後クリーンアップ
        setTimeout(()=>{
          try{ delete window[cb]; }catch(e){ window[cb]=null; }
          try{ s.remove(); }catch(e){}
        }, 2500);
      });
    }

    /* ------------ Forms: grids（予約フォームのレイアウト） ------------ */
    const style = document.createElement('style');
    style.textContent = `
      .form-grid{ display:grid; gap:16px; grid-template-columns:1fr 2fr; }
      .form-grid .col-2{ grid-column: span 2; }
      .form-grid-3{ display:grid; gap:16px; grid-template-columns:1fr 1fr 1fr; }
      @media (max-width: 900px){
        .form-grid{ grid-template-columns:1fr; gap:12px; }
        .form-grid .col-2{ grid-column:auto; }
        .form-grid-3{ grid-template-columns:1fr; gap:12px; }
      }
    `;
    document.head.append(style);

    /* ------------ Anchor offset & smooth scroll ------------ */
    function setHeaderHeightVar(){
      const h = $H('siteHeader')?.offsetHeight || 60;
      document.documentElement.style.setProperty('--header-h', h + 'px');
    }
    setHeaderHeightVar();
    window.addEventListener('resize', setHeaderHeightVar);
    $H('siteNav')?.addEventListener('click', (e)=>{
      const a = e.target.closest('a[href^="#"]'); if(!a) return;
      const id = a.getAttribute('href'); const el = document.querySelector(id); if(!el) return;
      e.preventDefault();
      const h = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-h')) || 60;
      const y = el.getBoundingClientRect().top + window.scrollY - h - 10;
      window.scrollTo({ top:y, behavior:'smooth' });
    });

    /* ------------ Init（★ awaitエラー解消：async化） ------------ */
    (async function init(){
      // 1) まずは localStorage（従来）→なければDEFAULT
      const stored = localStorage.getItem(STORAGE_KEY);
      const storedObj = stored ? safeJsonParse(stored) : null;

      window.__SITE_DATA__ = storedObj
        ? { ...DEFAULT_DATA, ...storedObj }
        : structuredClone(DEFAULT_DATA);

      ensureReviewDates(window.__SITE_DATA__);
      applyData(window.__SITE_DATA__);

      // 2) GAS（JSONP）を試す
      const remote = await loadFromPublicApiJSONP();

      if(remote && remote.ok && remote.data){
        // GAS成功 → 上書き + 保存
        window.__SITE_DATA__ = { ...DEFAULT_DATA, ...remote.data };
        ensureReviewDates(window.__SITE_DATA__);
        applyData(window.__SITE_DATA__);
        saveLocal();
      }else{
        // 3) GAS失敗 → キャッシュがあれば使う（保険）
        const cached = loadCache();
        if(cached){
          window.__SITE_DATA__ = { ...DEFAULT_DATA, ...cached };
          ensureReviewDates(window.__SITE_DATA__);
          applyData(window.__SITE_DATA__);
          saveLocal();
        }
      }

      // お知らせトグル
      const newsToggle = $H('newsToggle'), newsMore = $H('newsListMore'); let newsOpen = false;
      newsToggle.addEventListener('click', (e)=>{ e.preventDefault(); newsOpen = !newsOpen;
        newsMore.style.display = newsOpen ? 'grid' : 'none';
        newsToggle.setAttribute('aria-expanded', String(newsOpen));
        newsToggle.textContent = newsOpen ? '過去のお知らせを閉じる' : '過去のお知らせも見る';
      });

      // 口コミトグル
      const rvToggle = $H('reviewsToggle'), rvMore = $H('reviewsListMore'); let rvOpen = false;
      rvToggle.addEventListener('click', (e)=>{ e.preventDefault(); rvOpen = !rvOpen;
        rvMore.style.display = rvOpen ? 'grid' : 'none';
        rvToggle.setAttribute('aria-expanded', String(rvOpen));
        rvToggle.textContent = rvOpen ? '過去の口コミを閉じる' : '過去の口コミも見る';
      });

      // 送信デモ
      document.getElementById('reserveForm').addEventListener('submit', e=>{
        e.preventDefault(); alert('送信ありがとうございました！※ 実運用の送信先は編集画面で設定してください。');
      });
    })();

    /* ================================
       ★ 追記：Liquid Glass 自動有効化（header/footerのみ）
       ================================ */
    (function(){
      try{
        var supports = window.CSS && (CSS.supports('backdrop-filter','blur(1px)') || CSS.supports('-webkit-backdrop-filter','blur(1px)'));
        if(supports){ document.body.classList.add('theme-liquid'); }
      }catch(e){}
    })();
  </script>

  <!-- 改訂No.003：ポイント/クーポン モーダル（この部分は別途運用） -->
  <style>
    .loy-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.38); display:none; z-index:80; }
    .loy-modal{ position:fixed; inset:auto 0 0 0; margin:auto; width:min(560px, calc(100% - 24px));
      background:#fff; border:1px solid #e8eaef; border-radius:16px; box-shadow:0 18px 60px rgba(0,0,0,.18); padding:16px; z-index:81; display:none; }
    .loy-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .loy-tabs{ display:flex; gap:8px; margin:8px 0 12px; }
    .loy-tab{ padding:.45rem .8rem; border:1px solid #e8eaef; border-radius:999px; cursor:pointer; }
    .loy-tab[aria-selected="true"]{ background:var(--badge-bg); color:var(--badge-fg); border-color: color-mix(in srgb, var(--brand) 30%, #e8eaef); }
    .loy-pane{ display:none; }
    .loy-pane.active{ display:block; }
    .loy-row{ display:flex; gap:8px; align-items:center; }
    .loy-input{ flex:1; padding:.7rem .9rem; border:1px solid #e8eaef; border-radius:10px; }
    .loy-btn{ padding:.7rem 1rem; border-radius:999px; border:1px solid #e8eaef; background:#fff; cursor:pointer; }
    .loy-btn.primary{ background:var(--brand); color:#fff; border-color:transparent; }
    .loy-progress{ height:10px; background:#f2f5f9; border-radius:999px; overflow:hidden; }
    .loy-progress > span{ display:block; height:100%; width:0%; background:var(--brand); }
    .loy-code{ font-family:ui-monospace, Menlo, Consolas, monospace; padding:.5rem .6rem; border:1px dashed #e8eaef; border-radius:10px; }
  </style>

  <div class="loy-backdrop" id="loyBackdrop"></div>
  <div class="loy-modal" id="loyModal" role="dialog" aria-modal="true" aria-labelledby="loyTitle">
    <div class="loy-head">
      <strong id="loyTitle">ポイント & クーポン</strong>
      <button id="loyClose" class="loy-btn" aria-label="閉じる">×</button>
    </div>
    <div class="loy-tabs" role="tablist">
      <button class="loy-tab" role="tab" id="tabPoint" aria-selected="true">ポイント</button>
      <button class="loy-tab" role="tab" id="tabCoupon" aria-selected="false">クーポン</button>
      <button class="loy-tab" role="tab" id="tabHowto" aria-selected="false">使い方</button>
    </div>

    <div id="panePoint" class="loy-pane active" role="tabpanel" aria-labelledby="tabPoint">
      <div class="loy-row" style="margin-bottom:8px;">
        <input id="loyId" class="loy-input" placeholder="電話番号またはメールを入力して登録">
        <button id="btnRegister" class="loy-btn">登録/更新</button>
      </div>
      <div class="loy-row" style="margin-bottom:8px;">
        <input id="loyNonce" class="loy-input" placeholder="店内QRで自動入力（今日の合言葉）">
        <button id="btnCheckin" class="loy-btn primary">チェックインする（1pt）</button>
      </div>
      <div class="loy-progress" title="10ptでクーポン発行"><span id="loyBar"></span></div>
      <p id="loyStatus" class="muted" style="margin:.5rem 0 0;">ポイント: 0 / 10</p>
    </div>

    <div id="paneCoupon" class="loy-pane" role="tabpanel" aria-labelledby="tabCoupon">
      <div id="couponList"><p class="muted">保有中のクーポンはありません。</p></div>
    </div>

    <div id="paneHowto" class="loy-pane" role="tabpanel" aria-labelledby="tabHowto">
      <ol style="margin-left:1rem;">
        <li>初回は上の欄に電話番号orメールを入れて<strong>登録</strong></li>
        <li>来店時はレジ横の<strong>QR</strong>を読み取り、上の<strong>チェックイン</strong>を押す</li>
        <li><strong>10pt</strong>で自動的にクーポンが発行されます</li>
      </ol>
      <small class="muted">※ 同日の複数チェックインはできません。</small>
    </div>
  </div>

  <script>
    /* 改訂No.003：ポイントMVP 連携（この部分は別途運用） */
    const API_BASE = '<<YOUR_GAS_EXEC_URL>>'; // 例: https://script.google.com/macros/s/xxx/exec
    const LS_ID = 'loy_member_id';
    const $q = (s, r=document)=>r.querySelector(s);

    $q('#openLoyalty')?.addEventListener('click', openLoy);
    $q('#loyClose')?.addEventListener('click', closeLoy);
    $q('#loyBackdrop')?.addEventListener('click', closeLoy);
    function openLoy(){ $q('#loyBackdrop').style.display='block'; $q('#loyModal').style.display='block'; initLoy(); }
    function closeLoy(){ $q('#loyBackdrop').style.display='none'; $q('#loyModal').style.display='none'; }

    const tabs = [['tabPoint','panePoint'],['tabCoupon','paneCoupon'],['tabHowto','paneHowto']];
    tabs.forEach(([t,p])=>{
      $q('#'+t).addEventListener('click', ()=>{
        tabs.forEach(([tt,pp])=>{
          $q('#'+tt).setAttribute('aria-selected', tt===t ? 'true' : 'false');
          $q('#'+pp).classList.toggle('active', pp===p);
        });
      });
    });

    async function initLoy(){
      const id = localStorage.getItem(LS_ID) || '';
      $q('#loyId').value = id;
      const urlNonce = new URLSearchParams(location.search).get('nonce');
      $q('#loyNonce').value = urlNonce || '';
      if(id){ /* refreshMe(id); */ }
    }

    $q('#btnRegister')?.addEventListener('click', async ()=>{
      alert('このポイント機能は別途運用です（LPの本件DB反映とは別）。');
    });

    $q('#btnCheckin')?.addEventListener('click', async ()=>{
      alert('このポイント機能は別途運用です（LPの本件DB反映とは別）。');
    });
  </script>
</body>
</html>
